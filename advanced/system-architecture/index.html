
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <meta name="author" content="Sentry">
      
      
        <link rel="canonical" href="https://getsentry.github.io/symbolicator/advanced/system-architecture/">
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-7.3.4">
    
    
      
        <title>System Architecture - Sentry Symbolicator</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.db9e7362.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.3f5d1f46.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
      <link rel="stylesheet" href="../../_css/extra.css">
    
    
      


    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    <script>function __prefix(e){return new URL("../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#system-architecture" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Sentry Symbolicator" class="md-header__button md-logo" aria-label="Sentry Symbolicator" data-md-component="logo">
      
  <img src="../../static/icon.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Sentry Symbolicator
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              System Architecture
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        
<a href="https://github.com/getsentry/symbolicator/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Sentry Symbolicator" class="md-nav__button md-logo" aria-label="Sentry Symbolicator" data-md-component="logo">
      
  <img src="../../static/icon.png" alt="logo">

    </a>
    Sentry Symbolicator
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/getsentry/symbolicator/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Introduction
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          Advanced
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Advanced" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Advanced
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../background-and-principles/" class="md-nav__link">
        Background and Principles
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          System Architecture
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        System Architecture
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#looking-up-debugunwind-information" class="md-nav__link">
    Looking up debug/unwind information
  </a>
  
    <nav class="md-nav" aria-label="Looking up debug/unwind information">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#objectmeta" class="md-nav__link">
    ObjectMeta
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-object-cache-key" class="md-nav__link">
    The object cache key
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#generating-all-possible-file-downloads-for-a-source" class="md-nav__link">
    Generating all possible file downloads for a source
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example" class="md-nav__link">
    Example
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../caching/" class="md-nav__link">
        Caching
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../symbol-lookup/" class="md-nav__link">
        Lookup Strategy
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../symbol-server-compatibility/" class="md-nav__link">
        Symbol Server Compatibility
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../source-bundles/" class="md-nav__link">
        Source Bundles
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          API
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="API" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          API
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../api/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../api/minidump/" class="md-nav__link">
        POST /minidump
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../api/symbolication/" class="md-nav__link">
        POST /symbolicate
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../api/applecrashreport/" class="md-nav__link">
        POST /applecrashreport
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../api/response/" class="md-nav__link">
        Symbolication Response
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../api/proxy/" class="md-nav__link">
        Symbol Server Proxy
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#looking-up-debugunwind-information" class="md-nav__link">
    Looking up debug/unwind information
  </a>
  
    <nav class="md-nav" aria-label="Looking up debug/unwind information">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#objectmeta" class="md-nav__link">
    ObjectMeta
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-object-cache-key" class="md-nav__link">
    The object cache key
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#generating-all-possible-file-downloads-for-a-source" class="md-nav__link">
    Generating all possible file downloads for a source
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example" class="md-nav__link">
    Example
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/getsentry/symbolicator/edit/master/docs/advanced/system-architecture.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="system-architecture">System Architecture</h1>
<p>This page describes the internal structure and processes of Symbolicator.</p>
<h2 id="looking-up-debugunwind-information">Looking up debug/unwind information</h2>
<p>When finding an object file for a image in a symbolication request, we do the
following:</p>
<ol>
<li>We generate all possible file downloads for each source, based on platform
   information and source filters. See <a href="../symbol-lookup/">Symbol Lookup</a>.</li>
<li>We download all files we can get and cache them keyed by source ID and
   filepath (<code>ObjectFile</code>).</li>
<li>Then we rank all downloaded files:<ol>
<li>Objects with debug or unwind information (depending on what we want to use
   the object for) are ranked at the top.</li>
<li>Objects with a symbol table are ranked second.</li>
<li>Unparseable objects are ranked somewhere at the bottom together with empty
   files, 404s etc.</li>
</ol>
</li>
<li>Then we generate a symcache or cficache from the best file, save it also
   keyed by source ID and filepath. In the cache dir, a symcache file now
   basically has the same filename as an object file, just in a different
   folder.</li>
</ol>
<h3 id="objectmeta"><code>ObjectMeta</code></h3>
<p>The issue with the above setup is that one would have to have all objects
permanently persisted on disk to be able to decide which symcache to use, which
is only feasible in a world with infinite disk space.</p>
<p>For this purpose we have the concept of an <code>ObjectMeta</code> cache, which stores
information about the quality of an <code>ObjectFile</code> and is persisted for much
longer. <code>ObjectFile</code>s are deleted just a few days after download while
<code>ObjectMeta</code>s stick around for as long as the symcache/cficache does.</p>
<h3 id="the-object-cache-key">The object cache key</h3>
<p>As mentioned earlier, <code>ObjectFile</code>s, symcaches/cficaches (and <code>ObjectMeta</code>s) are
cached by source ID and filepath. What this actually means depends on the source
type:</p>
<ul>
<li>For the HTTP source type (Microsoft SymStore etc) this is just the source ID
  as given in the symbolication request + the filepath of the download URL.</li>
<li>For S3 and GCS buckets this is the source ID and the object key/path (object
  as in S3 object).</li>
<li>For the Sentry source type this is the source ID and the numeric "Debug File
  Id".</li>
</ul>
<p>In summary, the cache key is just whatever is necessary to uniquely identify a
file within a source.</p>
<h3 id="generating-all-possible-file-downloads-for-a-source">Generating all possible file downloads for a source</h3>
<p>In step 1, we mentioned that we generate all possible file downloads. For most
filesystem-like source types this is a simple computation that takes an
<code>ObjectId</code> (really a quintuple of debug and code ID + debug name + code name)
and generates possible filepaths. The logic for this lives in
<code>src/utils/paths.rs</code>.</p>
<p>For the Sentry source type, this looks a bit different. Since Sentry already
builds some sort of index based on debug and code ID, we first have to issue an
HTTP request to Sentry to search for files based on those IDs. We get back a
list of numeric "Debug File Ids" (those are just the integer PK in Postgres)
that we then can download one by one.</p>
<p>Since this step is quite expensive for Sentry, it is cached separately. This
part is currently WIP.</p>
<h3 id="example">Example</h3>
<p>The logic for looking up debug information for an image looks as follows
(simplified, conflating code_name vs debug_name + code_id vs debug_id):</p>
<ul>
<li>Lookup of object <code>name=wkernel32.pdb, id=0xdeadbeef</code> (uncached, parallelized):<ul>
<li>(cached) Fetching sentry index for <code>id=0xdeadbeef</code> (uncached) -&gt; returns
  <code>[123456]</code></li>
<li>(cached) lookup of object <em>metadata</em> <code>[sentry, 123456]</code> -&gt; returns
  <code>has_debug_info=true, ...</code><ul>
<li>(cached) lookup of object <em>file</em> <code>[sentry, 123456]</code></li>
</ul>
</li>
<li>(cached) lookup of object <em>metadata</em> <code>[microsoft,
  /wkernel32.pdb/deadbeef/wkernel32.pdb]</code> -&gt; returns <code>has_debug_info=false,
  ...</code><ul>
<li>(cached) lookup of object <em>file</em> <code>[microsoft,
  /wkernel32.pdb/deadbeef/wkernel32.pdb]</code></li>
</ul>
</li>
<li>Sentry project symbol wins, because it has more than symbol table</li>
</ul>
</li>
<li>(cached) lookup of symcache <code>[sentry, 123456]</code></li>
</ul>
<p>All steps that are behind a caching layer are prefixed with <code>(cached)</code>. If a
cache hit occurs, the sub-bulletpoints are not executed.</p>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../background-and-principles/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Background and Principles" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Background and Principles
            </div>
          </div>
        </a>
      
      
        
        <a href="../caching/" class="md-footer__link md-footer__link--next" aria-label="Next: Caching" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Caching
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        
          Made with
          <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
            Material for MkDocs
          </a>
        
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../assets/javascripts/workers/search.8397ff9e.min.js", "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.1e84347e.min.js"></script>
      
    
  </body>
</html>